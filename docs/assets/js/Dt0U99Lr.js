import{ao as a,g as e,j as l,p as r,m as o,w as t,ap as n,aq as i,u as s,k as d,ad as u,ar as c,a6 as p,B as g,as as m,a1 as h,y as v,a2 as f,aM as y,C as _,aN as b,at as k,aO as w,D as C,ab as N,ag as x,ah as z,ac as j,aQ as O,E as T,r as V,av as J,W as M,aw as S}from"./DFilHWvT.js";import{_ as W}from"./DjzrIlqC.js";import{_ as B,a as K}from"./C762OUmN.js";import{u as I}from"./5Ea9PFM7.js";import{b as U}from"./CxAYDShj.js";import E from"./BLTQbtzu.js";const F={class:"g-container organization-container"},P={class:"w-full h-full"},R={class:"mb-[10px]"},q=B(Object.assign({name:"OrganizationManage"},{__name:"organizationManage",setup(B){const{elementHeight:q}=I({offset:233}),D=U("ORG_TYPE"),G=V(!1),H=V([]),L=V([]),Q=V({}),Y=V(""),A=V([]),X=async()=>{G.value=!0;try{const a=await K.sys.organization.list(ea.value);0===a.code?(H.value=a.data,A.value=[...H.value],a.data.length>0?(L.value=a.data.map(a=>a.id),O(Q.value)&&(Q.value=a.data[0]),await ta()):(Q.value={},la.value.data=[])):T.error("获取机构列表失败")}catch(a){console.error("获取机构数据失败:",a),T.error("获取机构数据失败")}finally{G.value=!1}},Z=a=>{Q.value=a,ta()},$=a(a=>{if(!a)return void(A.value=[...H.value]);const e=l=>l.filter(l=>!!l.orgName.includes(a)||!(!l.children||!l.children.length)&&(l.children=e([...l.children]),l.children.length>0));A.value=e(JSON.parse(JSON.stringify(H.value)))},300);e(()=>{X()});const aa=V(null),ea=V({orgName:""}),la=V({loading:!1,data:[],columns:[{type:"index",label:"序号",minWidth:60},{prop:"orgName",label:"机构名称",minWidth:200},{prop:"orgType",label:"机构分类",width:100,slot:"orgType"},{prop:"sort",label:"排序",width:80},{prop:"orgCode",label:"机构码",minWidth:150},{prop:"remark",label:"备注",minWidth:200},{prop:"operation",label:"操作",width:180,align:"center",fixed:"right",slot:"operation"}]}),ra=a(()=>{ta()},300),oa=()=>{aa.value.resetFields(),ra()},ta=async()=>{if(O(Q.value))la.value.data=[];else{la.value.loading=!0;try{const a=await K.sys.organization.getChildren({parentId:Q.value.id,...ea.value});0===a.code?la.value.data=a.data:(T.error("获取子机构列表失败"),la.value.data=[])}catch(a){console.error("获取子机构数据失败:",a),T.error("获取子机构数据失败"),la.value.data=[]}finally{la.value.loading=!1}}},na=V(!1),ia=V({}),sa=V(!1),da=()=>{sa.value=!1,ia.value={parentId:Q.value.id||""},na.value=!0},ua=()=>{na.value=!1,ia.value={},sa.value=!1,X()},ca=async({id:a})=>{try{const e=await K.sys.organization.delete({id:a});0===e.code?(T.success("删除成功"),X()):T.error(e.message||"删除失败")}catch(e){console.error("删除机构失败:",e),T.error("删除机构失败")}};return(a,e)=>{const O=g,T=u,V=J,B=S,K=h,I=j,U=z,H=f,X=x,ta=N,pa=k,ga=W,ma=i;return l(),r("div",F,[o(K,{shadow:"hover",class:"organization-tree-card g-children-thin-scrollbar"},{header:t(()=>[o(T,{modelValue:s(Y),"onUpdate:modelValue":e[0]||(e[0]=a=>p(Y)?Y.value=a:null),modelModifiers:{trim:!0},placeholder:"搜索机构",clearable:"",style:{width:"100%"},onKeyup:c(s($),["enter"]),onChange:s($)},{prefix:t(()=>[o(O,null,{default:t(()=>[o(s(m))]),_:1})]),_:1},8,["modelValue","onKeyup","onChange"])]),default:t(()=>[n((l(),r("div",P,[s(A).length?(l(),d(V,{key:0,data:s(A),props:{label:"orgName",value:"id"},"highlight-current":!0,"node-key":"id","current-node-key":s(Q).id,"default-expanded-keys":s(L),onNodeClick:Z},null,8,["data","current-node-key","default-expanded-keys"])):(l(),d(B,{key:1,description:"暂无数据"}))])),[[ma,s(G)]])]),_:1}),o(K,{shadow:"hover",class:"organization-list-card"},{header:t(()=>[o(ta,{ref_key:"searchFormRef",ref:aa,model:s(ea),"label-width":"80px"},{default:t(()=>[o(X,null,{default:t(()=>[o(U,{span:8},{default:t(()=>[o(I,{label:"机构名称",prop:"orgName"},{default:t(()=>[o(T,{modelValue:s(ea).orgName,"onUpdate:modelValue":e[1]||(e[1]=a=>s(ea).orgName=a),placeholder:"请输入机构名称",clearable:"",onKeyup:c(s(ra),["enter"])},null,8,["modelValue","onKeyup"])]),_:1})]),_:1}),o(U,{span:8,class:"pl-[10px]"},{default:t(()=>[o(H,{type:"primary",onClick:s(ra)},{default:t(()=>[...e[3]||(e[3]=[_("查询",-1)])]),_:1},8,["onClick"]),o(H,{onClick:oa},{default:t(()=>[...e[4]||(e[4]=[_("重置",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),default:t(()=>[v("div",R,[o(H,{type:"primary",onClick:da},{default:t(()=>[o(O,null,{default:t(()=>[o(s(y))]),_:1}),e[5]||(e[5]=_(" 新增子机构 ",-1))]),_:1})]),o(ga,{height:s(q),loading:s(la).loading,data:s(la).data,columns:s(la).columns,showPagination:!1},{orgType:t(({row:a})=>[v("span",null,C(s(D).get(a.orgType)||""),1)]),operation:t(({row:a})=>[o(H,{type:"primary",link:"",size:"small",onClick:e=>{return l=a,sa.value=!0,ia.value=JSON.parse(JSON.stringify(l)),void(na.value=!0);var l}},{default:t(()=>[o(O,null,{default:t(()=>[o(s(b))]),_:1}),e[6]||(e[6]=_("编辑 ",-1))]),_:1},8,["onClick"]),o(pa,{title:"确定要删除该机构吗？",width:"160",placement:"top","confirm-button-type":"danger",onConfirm:e=>{var l;(a=>a.children&&a.children.length>0)(l=a)?M.confirm("该机构包含子机构，确定要一并删除吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{ca(l)}).catch(()=>{}):ca(l)}},{reference:t(()=>[o(H,{type:"danger",link:"",size:"small"},{default:t(()=>[o(O,null,{default:t(()=>[o(s(w))]),_:1}),e[7]||(e[7]=_("删除 ",-1))]),_:1})]),_:1},8,["onConfirm"])]),_:1},8,["height","loading","data","columns"])]),_:1}),o(E,{visible:s(na),"onUpdate:visible":e[2]||(e[2]=a=>p(na)?na.value=a:null),"is-edit":s(sa),"org-data":s(ia),onSuccess:ua},null,8,["visible","is-edit","org-data"])])}}}),[["__scopeId","data-v-3cf1bd42"]]);export{q as default};
